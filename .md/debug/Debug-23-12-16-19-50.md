---
type: Debug
target_module: apps/web/app/lib/api.ts
status: Success
context_hash: Network Error causing auth bypass (main page load without login) and backend startup failure (Prisma P1000).
---

# Issue Description
1. **Frontend**: When the backend is down (`ERR_CONNECTION_REFUSED`), the frontend was optimistically redirecting to `/main` because `localStorage.getItem('token')` existed, skipping any validity check. The `api.ts` interceptor only handled `401`, not connection errors (undefined response).
2. **Backend**: The API server failed to start with `PrismaClientInitializationError: Authentication failed`. This indicates a mismatch between `.env` credentials and the running Docker Postgres container.

# Root Cause Analysis
- **Auth Bypass**: The client-side logic assumed "Token detection = Valid Session". It did not account for "Token exists but Server is dead".
- **Network Error**: The backend crash prevented any API calls.
- **Backend Crash**: Incorrect database password configuration in `apps/api/.env` vs Docker.

# Solution Implemented
1. **Frontend Interceptor Upgrade (`api.ts`)**:
   - Modified `api.interceptors.response.use` to catch errors where `error.response` is undefined (Network Error).
   - Action: Clear `token` and redirect to `/`.
   
   ```typescript
   if (error.response?.status === 401 || !error.response) {
     localStorage.removeItem('token');
     window.location.href = '/';
   }
   ```
   
2. **Backend Diagnosis**:
   - Identified `P1000` error code.
   - Advised user to verify `.env` matches Docker container credentials (cannot automFix password blindly).

# Verification
- **Scenario A (Server Down)**: User visits `/`. Token exists. Redirects to `/main`. API call fails (Network Error). Interceptor catches it. Redirects back to `/`. -> **Pass** (Prevents stuck empty state).
- **Scenario B (Server Up)**: Normal flow.

# Pending Actions
- User must fix `.env` password and restart `pnpm dev`.
